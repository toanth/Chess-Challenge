using System;
using System.Data;
using System.Diagnostics;
using System.Linq;
using ChessChallenge.API;

// This compression isn't really novel. It combines ideas from Skolin, folke, JW and probably others in a way
// that results in a lossless(*) compression using relatively few tokens
// (*) The compression is lossless except for the square a8 in the middle game knight table, which is too
// large by 41 (but still rated very negatively). This shouldn't make a big difference in practice, though.
public class Pesto
{
    // Apparently, there's no way to make arrays immutable in C#, so these are functions that return temporaries.
    public static int[] piecePhase => new int[]{ 0, 1, 1, 2, 4, 0 };
        
    // public static int[] pestoPieceValues => new int[]{82, 337, 365, 477, 1025, 100,
    //                                                   94, 281, 297, 512, 936, 100};
    
    // public static int[][] pestoPsqts =>
    //     new int[][]{
    //         new int[]
    //         {
    //             // pawn mg
    //             0, 0, 0, 0, 0, 0, 0, 0,
    //             98, 134, 61, 95, 68, 126, 34, -11,
    //             -6, 7, 26, 31, 65, 56, 25, -20,
    //             -14, 13, 6, 21, 23, 12, 17, -23,
    //             -27, -2, -5, 12, 17, 6, 10, -25,
    //             -26, -4, -4, -10, 3, 3, 33, -12,
    //             -35, -1, -20, -23, -15, 24, 38, -22,
    //             0, 0, 0, 0, 0, 0, 0, 0
    //         },
    //         new int[]
    //         {
    //             // knight mg
    //             -167, -89, -34, -49, 61, -97, -15, -107,
    //             -73, -41, 72, 36, 23, 62, 7, -17,
    //             -47, 60, 37, 65, 84, 129, 73, 44,
    //             -9, 17, 19, 53, 37, 69, 18, 22,
    //             -13, 4, 16, 13, 28, 19, 21, -8,
    //             -23, -9, 12, 10, 19, 17, 25, -16,
    //             -29, -53, -12, -3, -1, 18, -14, -19,
    //             -105, -21, -58, -33, -17, -28, -19, -23
    //         },
    //         new int[]
    //         {
    //             // bishop mg
    //             -29, 4, -82, -37, -25, -42, 7, -8,
    //             -26, 16, -18, -13, 30, 59, 18, -47,
    //             -16, 37, 43, 40, 35, 50, 37, -2,
    //             -4, 5, 19, 50, 37, 37, 7, -2,
    //             -6, 13, 13, 26, 34, 12, 10, 4,
    //             0, 15, 15, 15, 14, 27, 18, 10,
    //             4, 15, 16, 0, 7, 21, 33, 1,
    //             -33, -3, -14, -21, -13, -12, -39, -21
    //         },
    //         new int[]
    //         {
    //             // rook mg
    //             32, 42, 32, 51, 63, 9, 31, 43,
    //             27, 32, 58, 62, 80, 67, 26, 44,
    //             -5, 19, 26, 36, 17, 45, 61, 16,
    //             -24, -11, 7, 26, 24, 35, -8, -20,
    //             -36, -26, -12, -1, 9, -7, 6, -23,
    //             -45, -25, -16, -17, 3, 0, -5, -33,
    //             -44, -16, -20, -9, -1, 11, -6, -71,
    //             -19, -13, 1, 17, 16, 7, -37, -26
    //         },
    //         new int[]
    //         {
    //             // queen mg
    //             -28, 0, 29, 12, 59, 44, 43, 45,
    //             -24, -39, -5, 1, -16, 57, 28, 54,
    //             -13, -17, 7, 8, 29, 56, 47, 57,
    //             -27, -27, -16, -16, -1, 17, -2, 1,
    //             -9, -26, -9, -10, -2, -4, 3, -3,
    //             -14, 2, -11, -2, -5, 2, 14, 5,
    //             -35, -8, 11, 2, 8, 15, -3, 1,
    //             -1, -18, -9, 10, -15, -25, -31, -50
    //         },
    //         new int[]
    //         {
    //             // king mg
    //             -65, 23, 16, -15, -56, -34, 2, 13,
    //             29, -1, -20, -7, -8, -4, -38, -29,
    //             -9, 24, 2, -16, -20, 6, 22, -22,
    //             -17, -20, -12, -27, -30, -25, -14, -36,
    //             -49, -1, -27, -39, -46, -44, -33, -51,
    //             -14, -14, -22, -46, -44, -30, -15, -27,
    //             1, 7, -8, -64, -43, -16, 9, 8,
    //             -15, 36, 12, -54, 8, -28, 24, 14
    //         },
    //         //new int[]
    //         //{
    //         //    // king mg, King on the Hill
    //         //    7,  7,  7,  7,  7,  7,  7,  7,
    //         //    6,  25, 50, 50, 50, 50, 25, 6,
    //         //    5,  25, 85 ,150,150,85 ,25, 5,
    //         //    4,  25, 100,200,200,100,25, 4,
    //         //    3,  25, 100,200,200,100,25, 3,
    //         //    2,  25, 75, 100,100,75 ,25, 2,
    //         //    1,  25, 50, 50, 50, 50, 25, 1,
    //         //    0,  0,  8,  0,  0,  0,  8,  0
    //         //},
    //          //new int[]
    //          //{
    //          //    // king mg, Gᴀᴍʙᴏᴛ
    //          //    255, 255, 255, 255, 255, 255, 255, 255,
    //          //    255, 255, 255, 255, 255, 255, 255, 255,
    //          //    255, 255, 255, 255, 255, 255, 255, 255,
    //          //    250, 250, 250, 250, 250, 250, 250, 250,
    //          //    200, 200, 200, 200, 200, 200, 200, 200,
    //          //    100, 100, 100, 100, 100, 100, 100, 100,
    //          //    10, 10, 50, 50, 50, 50, 30, 10,
    //          //    0, 0, 0, 3, 5, 2, 0, 0
    //          //},
    //         new int[]
    //         {
    //             // pawn eg
    //             0, 0, 0, 0, 0, 0, 0, 0,
    //             178, 173, 158, 134, 147, 132, 165, 187,
    //             94, 100, 85, 67, 56, 53, 82, 84,
    //             32, 24, 13, 5, -2, 4, 17, 17,
    //             13, 9, -3, -7, -7, -8, 3, -1,
    //             4, 7, -6, 1, 0, -5, -1, -8,
    //             13, 8, 8, 10, 13, 0, 2, -7,
    //             0, 0, 0, 0, 0, 0, 0, 0,
    //         },
    //         new int[]
    //         {
    //             // knight eg
    //             -58, -38, -13, -28, -31, -27, -63, -99,
    //             -25, -8, -25, -2, -9, -25, -24, -52,
    //             -24, -20, 10, 9, -1, -9, -19, -41,
    //             -17, 3, 22, 22, 22, 11, 8, -18,
    //             -18, -6, 16, 25, 16, 17, 4, -18,
    //             -23, -3, -1, 15, 10, -3, -20, -22,
    //             -42, -20, -10, -5, -2, -20, -23, -44,
    //             -29, -51, -23, -15, -22, -18, -50, -64
    //         },
    //         new int[]
    //         {
    //             // bishop eg
    //             -14, -21, -11, -8, -7, -9, -17, -24,
    //             -8, -4, 7, -12, -3, -13, -4, -14,
    //             2, -8, 0, -1, -2, 6, 0, 4,
    //             -3, 9, 12, 9, 14, 10, 3, 2,
    //             -6, 3, 13, 19, 7, 10, -3, -9,
    //             -12, -3, 8, 10, 13, 3, -7, -15,
    //             -14, -18, -7, -1, 4, -9, -15, -27,
    //             -23, -9, -23, -5, -9, -16, -5, -17
    //         },
    //         new int[]
    //         {
    //             // rook eg
    //             13, 10, 18, 15, 12, 12, 8, 5,
    //             11, 13, 13, 11, -3, 3, 8, 3,
    //             7, 7, 7, 5, 4, -3, -5, -3,
    //             4, 3, 13, 1, 2, 1, -1, 2,
    //             3, 5, 8, 4, -5, -6, -8, -11,
    //             -4, 0, -5, -1, -7, -12, -8, -16,
    //             -6, -6, 0, 2, -9, -9, -11, -3,
    //             -9, 2, 3, -1, -5, -13, 4, -20
    //         },
    //         new int[]
    //         {
    //             // queen eg
    //             -9, 22, 22, 27, 27, 19, 10, 20,
    //             -17, 20, 32, 41, 58, 25, 30, 0,
    //             -20, 6, 9, 49, 47, 35, 19, 9,
    //             3, 22, 24, 45, 57, 40, 57, 36,
    //             -18, 28, 19, 47, 31, 34, 39, 23,
    //             -16, -27, 15, 6, 9, 17, 10, 5,
    //             -22, -23, -30, -16, -16, -23, -36, -32,
    //             -33, -28, -22, -43, -5, -32, -20, -41
    //         },
    //         new int[]
    //         {
    //             // king eg
    //             -74, -35, -18, -18, -11, 15, 4, -17,
    //             -12, 17, 14, 17, 17, 38, 23, 11,
    //             10, 17, 23, 15, 20, 45, 44, 13,
    //             -8, 22, 24, 27, 26, 33, 26, 3,
    //             -18, -4, 21, 24, 27, 23, 9, -11,
    //             -19, -3, 11, 21, 23, 16, 7, -9,
    //             -27, -11, 4, 13, 14, 4, -5, -17,
    //             -53, -34, -21, -11, -28, -14, -24, -43
    //         },
    //     };

    public static double[][] rawTunedPsqts = {
//  new[] { // pawn mg
// 0, 0, 0, 0, 0, 0, 0, 0, 
// 61.4742, 76.8091, 61.9822, 88.7811, 80.9947, 64.4359, -1.61248, -31.2022, 
// -16.6968, 0.598718, 32.26, 36.4527, 41.639, 66.1645, 41.8597, 0.0551868, 
// -28.3823, -3.21076, -0.863185, 2.48628, 23.2088, 14.8561, 20.2898, -6.07906, 
// -40.8827, -10.817, -12.9597, 4.79874, 4.82268, -3.96188, 6.15703, -23.8731, 
// -40.9491, -15.2997, -14.2824, -14.4708, 1.01962, -11.372, 22.1392, -10.3155, 
// -40.9611, -12.4512, -20.0694, -27.8069, -8.5507, 8.72162, 33.2645, -15.2653, 
// 0, 0, 0, 0, 0, 0, 0, 0, 
//  },
//
//  new[] { // knight mg
// -164.042, -102.978, -40.9981, -19.1211, 27.756, -58.4155, -96.8695, -96.4965, 
// -24.3739, 2.86012, 48.2115, 46.1861, 48.4596, 97.5945, 10.0623, 21.983, 
// 4.86819, 40.1901, 54.8547, 72.3591, 109.416, 113.676, 66.5239, 30.7262, 
// 4.35425, 16.2021, 38.6507, 62.0189, 40.8974, 68.4634, 22.5989, 37.7417, 
// -11.0923, 4.44714, 18.69, 20.2335, 29.5407, 25.8987, 24.0155, -4.1234, 
// -28.5006, -6.75289, 9.31786, 11.0348, 21.5084, 11.2161, 15.5456, -15.0982, 
// -41.5471, -30.504, -13.0829, -1.87183, -0.430679, 2.39242, -11.0058, -14.0469, 
// -85.2025, -29.3712, -47.0909, -30.5784, -27.7988, -15.3401, -27.9823, -60.3385, 
//  },
//
//  new[] { // bishop mg
// -5.53561, -29.8565, -15.7563, -55.1519, -59.6495, -29.614, -0.887362, -41.5772, 
// 1.86575, 32.9228, 19.7603, 7.03914, 35.1224, 43.6678, 27.6825, 22.2202, 
// 13.0494, 39.1413, 48.0572, 63.0708, 54.0886, 80.5317, 59.8323, 47.6004, 
// 4.05667, 18.033, 43.3725, 53.7409, 49.8618, 44.7268, 22.326, 7.79835, 
// 0.567105, 16.0258, 21.1234, 42.081, 40.0393, 22.7015, 15.795, 6.94759, 
// 14.6844, 20.3, 20.6279, 22.8117, 24.7141, 19.8739, 20.4768, 25.8066, 
// 14.6352, 19.2131, 26.0086, 6.88768, 13.028, 27.3055, 35.4553, 19.1076, 
// -6.6927, 11.5181, -0.754521, -11.3107, -8.57373, -10.2811, 16.6056, 1.28562, 
//  },
//
//  new[] { // rook mg
// 30.9866, 24.8535, 36.0076, 39.4923, 59.2049, 79.2495, 56.0266, 70.1421, 
// 9.82154, 6.69162, 30.8735, 52.804, 36.4711, 67.9338, 56.9524, 82.4847, 
// -10.91, 10.8792, 11.8696, 18.4525, 45.7663, 47.8883, 86.2325, 61.2667, 
// -28.8335, -13.3269, -8.3989, 0.262643, 3.34683, 4.41368, 16.0485, 18.1017, 
// -46.0718, -43.5362, -34.6229, -20.5646, -20.1339, -35.1199, -10.0043, -21.0284, 
// -53.4675, -42.1393, -33.927, -33.0759, -28.6487, -31.1891, 3.75847, -18.4812, 
// -57.001, -42.4423, -29.3285, -31.4967, -27.1717, -24.6005, -6.76298, -40.434, 
// -36.6054, -34.5836, -24.0987, -18.8748, -14.9056, -25.4853, -13.5082, -31.9248, 
//  },
//
//  new[] { // queen mg
// -31.9744, -24.7257, 8.95465, 42.2306, 45.1742, 51.348, 55.3752, -1.42737, 
// -1.653, -19.913, -14.8159, -24.8958, -19.1168, 30.4371, 8.25993, 57.6183, 
// -0.776841, -0.872672, 3.25077, 18.6097, 24.328, 66.5413, 69.7197, 63.4402, 
// -15.6982, -12.0328, -5.35876, -7.04128, -3.80153, 8.37416, 6.82106, 15.4256, 
// -15.7111, -13.169, -15.5711, -8.8334, -6.46855, -7.46969, 4.44753, 4.43944, 
// -15.731, -5.66995, -11.9768, -11.2305, -9.20864, -1.35277, 10.1197, 2.19518, 
// -18.1675, -9.85981, -0.256661, 0.326711, -1.35769, 8.83263, 13.6411, 20.8814, 
// -16.8683, -27.9045, -19.9928, -2.97966, -14.8582, -29.3972, -12.7704, -13.7326, 
//  },
// //
// //  new[] { // king mg
// // 42.0428, 15.1956, 47.4822, -48.0063, -3.05258, 19.8737, 43.0876, 97.4895, 
// // -60.9011, -8.16286, -46.5838, 22.5756, -8.22744, 9.88959, 0.370426, -25.9482, 
// // -78.2982, 28.153, -51.3366, -57.4664, -40.3432, 33.8456, 20.4121, -33.5429, 
// // -61.8691, -68.7541, -76.3238, -121.332, -116.038, -81.9708, -76.5355, -108.197, 
// // -56.4568, -63.9987, -95.0025, -129.196, -126.578, -97.3113, -94.3084, -123.255, 
// // -23.3088, -8.67298, -68.3872, -81.7868, -76.7872, -72.559, -27.3333, -44.8785, 
// // 59.5369, 18.1986, 1.17613, -37.9647, -37.4787, -15.7298, 34.1884, 43.5716, 
// // 50.5044, 78.1471, 50.9409, -53.0654, 15.1116, -26.6304, 57.849, 58.9514, 
// //  },
//  
//     new double []
//     {
//         // king mg, Gᴀᴍʙᴏᴛ
//         255, 255, 255, 255, 255, 255, 255, 255,
//         255, 255, 255, 255, 255, 255, 255, 255,
//         255, 255, 255, 255, 255, 255, 255, 255,
//         250, 250, 250, 250, 250, 250, 250, 250,
//         200, 200, 200, 200, 200, 200, 200, 200,
//         100, 100, 100, 100, 100, 100, 100, 100,
//         10, 10, 50, 50, 50, 50, 30, 10,
//         0, 0, 0, 3, 5, 2, 0, 0
//     },
//
//  new[] { // pawn eg
// 0, 0, 0, 0, 0, 0, 0, 0, 
// 180.025, 173.583, 168.149, 123.339, 116.332, 129.085, 175.841, 186.965, 
// 116.094, 121.311, 89.9138, 69.0206, 59.1267, 44.6699, 89.8507, 90.3522, 
// 45.217, 33.8705, 14.9194, 5.60962, -3.5089, 0.271804, 17.602, 19.2704, 
// 20.8314, 16.9447, -0.407779, -4.084, -5.65572, -4.12922, 6.26506, 1.88682, 
// 14.2813, 15.231, -2.21541, 10.3953, 2.86566, 0.663466, 4.48506, -3.59337, 
// 19.8352, 18.6552, 8.0156, 12.4326, 14.311, 5.39673, 3.3198, -3.41385, 
// 0, 0, 0, 0, 0, 0, 0, 0, 
//  },
//
//  new[] { // knight eg
// -67.4049, -26.2821, -10.4508, -14.9564, -18.8819, -31.1167, -17.9483, -101.037, 
// -26.625, -7.5018, -6.48681, -0.502402, -13.9773, -24.7412, -15.4529, -43.9752, 
// -13.8383, -0.42789, 19.3973, 18.444, 0.897701, -2.52805, -10.6718, -22.601, 
// -2.94244, 19.4071, 30.3243, 32.5611, 34.0512, 26.7293, 19.2722, -11.2306, 
// -0.901055, 9.06172, 32.4185, 32.6176, 35.5028, 24.3148, 9.09316, -7.05735, 
// -16.8025, 2.631, 9.47699, 25.7156, 24.1755, 7.8308, -3.81792, -15.2697, 
// -25.3581, -10.7712, -1.39296, 3.54629, 2.20649, -2.80051, -18.2578, -16.7849, 
// -34.1387, -44.3888, -14.8948, -10.9385, -11.405, -20.3214, -40.0434, -40.6063, 
//  },
//
//  new[] { // bishop eg
// -1.75695, 7.90366, 5.76462, 20.0822, 16.4763, 6.53741, -1.68725, 1.11062, 
// -11.5771, 4.94435, 10.6085, 10.9284, 5.37564, 0.263164, 9.97533, -18.1571, 
// 15.6744, 10.0917, 18.23, 10.5996, 13.7708, 16.6315, 8.89658, 6.7011, 
// 12.8392, 28.8769, 21.3461, 34.1155, 28.0663, 23.6166, 23.3114, 9.45196, 
// 6.8524, 23.0387, 31.7485, 27.3502, 27.3696, 27.4444, 19.0931, -2.81815, 
// 4.58752, 16.1218, 23.6631, 24.2684, 27.9946, 23.2456, 6.6225, -4.89388, 
// 0.0224292, -0.547432, -0.7302, 14.4329, 16.7449, 3.78045, 4.91195, -18.1977, 
// -15.4406, 0.760267, -18.2475, 5.72417, 1.31838, 0.647928, -14.087, -23.6491, 
//  },
//
//  new[] { // rook eg
// 29.6991, 34.3708, 40.2132, 36.9579, 27.8571, 16.1966, 19.8068, 16.9289, 
// 29.1443, 41.8295, 42.8011, 33.6312, 33.5983, 19.6645, 15.8476, 3.1929, 
// 29.7989, 31.1944, 32.811, 30.056, 17.3652, 12.0663, 3.39807, -0.178781, 
// 31.4165, 29.3007, 37.3758, 33.782, 21.1387, 15.9967, 10.8843, 4.67841, 
// 24.8139, 29.6544, 32.0806, 30.5928, 25.9078, 24.1226, 10.3627, 5.90771, 
// 20.3622, 20.3078, 20.0868, 23.9056, 20.1391, 12.3667, -7.64207, -6.39957, 
// 16.9022, 19.1655, 20.8662, 22.374, 13.9807, 10.2635, 0.647667, 8.03791, 
// 12.0013, 21.2145, 27.8919, 27.3117, 18.8049, 14.0732, 11.5443, -1.19939, 
//  },
//
//  new[] { // queen eg
// 30.6975, 46.181, 58.2402, 46.9935, 41.9754, 35.6192, -2.1996, 36.9704, 
// 3.33721, 39.1604, 74.3753, 96.6778, 110.324, 71.6296, 53.5987, 14.5172, 
// 9.7693, 27.5496, 64.1969, 65.8982, 85.1073, 58.7254, 22.9411, 9.35575, 
// 19.645, 45.6673, 55.8161, 81.3488, 94.4774, 81.6033, 66.5688, 42.4543, 
// 22.3546, 44.6956, 55.3266, 79.1525, 71.8928, 62.4285, 43.5759, 30.0829, 
// 4.11867, 17.694, 46.0843, 41.4, 46.68, 36.9439, 17.2931, 3.99802, 
// 4.70503, 6.75413, 2.14922, 11.5118, 13.9885, -14.8758, -40.2779, -63.0634, 
// -3.03756, 1.42985, 3.38456, -11.6852, 1.94642, -0.720648, -23.4981, -28.9655, 
//  },
//
//  new[] { // king eg
// -93.5782, -43.7096, -36.7898, -1.51752, -12.9665, -5.98356, -10.4724, -84.4329, 
// -10.1165, 15.7356, 24.609, 12.7351, 27.5313, 39.4278, 37.5747, 10.8929, 
// 3.72755, 20.6345, 39.4641, 45.6396, 47.8565, 43.2778, 43.976, 19.4155, 
// -6.29097, 27.0174, 43.4151, 56.0193, 55.9929, 52.2279, 43.9628, 21.9009, 
// -17.6072, 13.7789, 38.2464, 53.5664, 53.9893, 43.0406, 29.9747, 14.3277, 
// -24.0949, -0.236597, 22.0916, 34.4193, 34.5415, 27.0166, 7.80695, -4.87808, 
// -42.9841, -15.3963, -1.14739, 11.169, 13.6708, 4.43046, -15.0379, -33.9429, 
// -74.1308, -57.5923, -37.9693, -17.9026, -44.8889, -20.3823, -48.1581, -76.8532, 
//  },
// };

 new[] { // pawn mg
0, 0, 0, 0, 0, 0, 0, 0, 
68.3954, 77.6791, 65.9413, 97.3875, 80.1062, 83.1029, -7.38317, -30.7093, 
-19.956, 2.4297, 34.9079, 40.0774, 43.8448, 68.3219, 45.9334, 2.24837, 
-29.6373, -4.17538, 0.515121, 4.15036, 25.7974, 17.3123, 23.5795, -1.69928, 
-42.5898, -10.7801, -12.7177, 6.6319, 5.81483, -2.06398, 10.2927, -19.3336, 
-42.592, -14.9063, -13.9366, -15.2564, 0.685241, -9.49178, 25.2756, -5.43003, 
-40.5002, -9.75122, -17.256, -26.3876, -8.7175, 14.8609, 44.8553, -7.46319, 
0, 0, 0, 0, 0, 0, 0, 0, 
 },

 new[] { // knight mg
-138.383, -90.9768, -24.3821, -19.6105, 36.3447, -65.6839, -68.8951, -58.184, 
-19.8567, 7.83398, 61.8552, 48.6297, 62.1738, 109.713, 33.3959, 36.1757, 
10.7356, 50.0172, 59.6787, 85.0541, 114.778, 144.208, 74.0251, 53.2821, 
6.93367, 18.8569, 42.7647, 67.7101, 45.0788, 75.0367, 24.6854, 42.4924, 
-8.37464, 7.90235, 22.4196, 23.7678, 33.9511, 29.0492, 30.5083, -1.26558, 
-27.5214, -4.63708, 12.4552, 12.8318, 24.6355, 13.4632, 17.4718, -13.9253, 
-38.7019, -29.319, -11.7009, 1.63093, 1.40901, 7.07521, -3.54096, -8.52886, 
-84.3192, -26.2944, -45.8103, -29.568, -25.6902, -11.0548, -28.4972, -64.7389, 
 },

 new[] { // bishop mg
4.19465, -23.1282, -7.40596, -60.6588, -60.6937, -36.4598, 41.2451, -20.0762, 
4.27202, 43.791, 20.5637, 15.1621, 32.4718, 63.1393, 28.1113, 38.6402, 
17.6414, 43.8775, 60.2658, 66.9367, 63.8137, 88.387, 82.5031, 44.8051, 
6.35608, 25.4872, 47.5023, 65.1936, 55.6878, 52.3454, 24.916, 20.0123, 
5.56461, 18.9915, 26.1659, 46.8308, 48.2845, 25.7673, 21.4497, 8.42141, 
18.0074, 24.5145, 23.8156, 27.0022, 27.37, 24.5046, 21.697, 34.9766, 
18.6673, 23.4183, 30.8146, 10.0868, 17.1627, 32.3497, 47.3131, 23.2566, 
-6.06909, 13.0691, 2.43723, -5.26995, -4.37032, -6.63352, 16.9826, 8.27791, 
 },

 new[] { // rook mg
66.6678, 67.9779, 75.0055, 74.6045, 98.6976, 133.657, 154.455, 159.052, 
18.8519, 11.4643, 37.068, 61.2833, 42.3956, 70.7634, 68.4656, 125.629, 
-4.49619, 16.9407, 17.3785, 30.7616, 56.8555, 56.2622, 102.701, 60.6183, 
-27.9145, -10.2582, -5.76948, 12.0376, 15.4733, 16.8716, 26.0545, 12.1094, 
-47.6679, -44.4925, -33.7608, -12.9956, -10.8614, -26.7736, -7.45563, -30.9707, 
-55.8173, -41.6639, -33.0792, -27.1495, -22.1751, -22.5439, 9.21004, -20.7661, 
-58.6364, -41.3618, -26.69, -24.3898, -20.6891, -13.0603, 3.90183, -55.7649, 
-39.1494, -35.3099, -23.3135, -2.36808, -5.47191, -12.7954, -23.9078, -61.2046, 
 },

 new[] { // queen mg
-17.3618, 7.92657, 33.0183, 70.6182, 75.0356, 121.105, 140.659, 75.5598, 
-3.75041, -24.7946, -20.3953, -28.9444, -29.0833, 39.3749, 17.6682, 119.475, 
-2.00515, -4.35871, 2.68012, 15.468, 23.3556, 63.9612, 80.4181, 56.7785, 
-19.7574, -13.8625, -9.63845, -9.48943, -3.8141, 6.54161, 8.34076, 18.816, 
-20.2647, -17.5726, -18.7551, -12.4146, -8.64476, -9.81962, 1.41174, 3.23499, 
-19.7801, -9.69886, -15.6023, -13.8501, -10.4021, -3.79525, 6.75083, 0.393565, 
-21.815, -11.9157, -3.58453, 1.44346, -3.27348, 10.855, 19.4314, 26.5171, 
-23.1738, -34.2561, -23.7291, -6.41694, -17.5677, -29.9964, -37.0333, -41.4227, 
 },

 new double[] { // king mg
255, 255, 255, 255, 255, 255, 255, 255, 
255, 255, 255, 255, 255, 255, 255, 255, 
255, 255, 255, 255, 255, 255, 255, 255, 
250, 250, 250, 250, 250, 250, 250, 250, 
200, 200, 200, 200, 200, 200, 200, 200, 
100, 100, 100, 100, 100, 100, 100, 100, 
10, 10, 50, 50, 50, 50, 30, 10, 
0, 0, 0, 3, 5, 2, 0, 0, 
 },

 new[] { // pawn eg
0, 0, 0, 0, 0, 0, 0, 0, 
198.357, 192.507, 181.295, 131.539, 123.306, 138.163, 193.331, 204.54, 
129.165, 131.563, 95.2993, 70.9661, 57.2765, 44.6029, 95.5353, 95.9368, 
50.9587, 36.4221, 14.0525, 1.17844, -9.65687, -5.75809, 14.6803, 19.1052, 
24.0327, 18.2097, -2.11598, -8.58127, -10.6053, -7.18761, 6.00673, 2.50404, 
16.1989, 17.6094, -3.00445, 6.69825, 1.25872, 0.188812, 8.89712, -0.394251, 
22.5604, 23.0164, 12.3929, 15.1279, 16.5862, 12.7506, 10.8935, -1.94948, 
0, 0, 0, 0, 0, 0, 0, 0, 
 },

 new[] { // knight eg
-74.558, -20.8876, -4.19248, -5.04323, -6.79998, -20.0793, -8.81697, -106.577, 
-19.7072, 1.62092, 2.58905, 9.73734, -3.62854, -15.1531, -8.65544, -31.7204, 
-6.29871, 7.90244, 30.2004, 24.5445, 6.1932, 3.84323, -3.85207, -20.1739, 
5.35143, 31.6956, 40.9992, 45.1614, 42.5192, 37.4547, 28.1295, -1.93169, 
7.36639, 20.2089, 44.4075, 44.032, 47.0367, 36.2526, 20.6041, 2.90243, 
-10.2042, 11.816, 20.7886, 37.4268, 38.1996, 16.2353, 8.29615, -7.41862, 
-16.3974, 0.0955989, 11.029, 12.8074, 12.3203, 11.3458, -2.85243, -6.10788, 
-28.0265, -40.7295, -5.33699, 0.0142935, -1.89412, -3.66622, -34.0146, -32.7846, 
 },

 new[] { // bishop eg
6.2202, 18.3758, 15.5379, 30.7078, 29.8723, 20.5405, 7.22139, 7.20671, 
-4.47409, 15.6161, 21.8506, 22.8674, 16.5455, 8.22133, 25.3918, -4.50458, 
26.7797, 18.4503, 29.4437, 18.1644, 22.8577, 25.9041, 13.1922, 16.2334, 
19.4686, 40.4718, 29.9379, 44.8735, 37.066, 32.074, 33.2943, 16.1175, 
16.5899, 30.9909, 44.8515, 35.8713, 37.8662, 37.8544, 31.4146, 6.03916, 
13.1964, 28.0126, 33.7226, 33.3162, 38.4878, 36.4192, 19.6925, 6.32887, 
9.21502, 6.98926, 11.2622, 24.2587, 29.6091, 20.17, 19.4741, -10.2388, 
-9.94315, 11.9653, -12.1847, 18.2833, 13.075, 15.394, -4.06559, -18.095, 
 },

 new[] { // rook eg
30.7313, 36.068, 44.6947, 43.8972, 36.6579, 23.2993, 15.7814, 11.6884, 
33.8343, 51.4114, 52.2156, 42.2864, 43.9621, 37.7225, 31.864, 5.79331, 
37.6831, 39.9099, 41.0308, 36.6623, 25.1124, 19.5306, 12.3497, 10.4549, 
40.7512, 37.5631, 47.0349, 40.5894, 26.882, 18.984, 16.6099, 13.8525, 
34.7437, 40.7939, 42.4866, 40.0621, 36.5979, 34.3455, 21.5259, 19.9618, 
28.8807, 28.0829, 28.5813, 32.6033, 31.3642, 20.7382, 1.03581, 2.15344, 
22.1079, 25.723, 28.3002, 31.3876, 23.5804, 19.4123, 3.77721, 14.4467, 
15.2188, 28.3717, 36.5377, 33.3373, 28.4156, 23.7401, 16.8776, 1.40563, 
 },

 new[] { // queen eg
59.2698, 65.4247, 81.7849, 64.2653, 56.3097, 48.6005, 16.3134, 52.8414, 
33.6382, 74.8371, 111.886, 131.172, 146.823, 103.555, 117.929, 42.9899, 
38.8493, 56.0387, 95.6826, 94.1459, 117.057, 89.1276, 45.7556, 46.885, 
45.8966, 73.0418, 83.4205, 108.602, 122.886, 105.965, 89.759, 65.9918, 
49.588, 74.5748, 81.0522, 106.588, 97.2994, 88.794, 76.1828, 62.2399, 
32.7939, 41.751, 73.0696, 64.3475, 71.3679, 63.1141, 51.0726, 35.0286, 
32.0703, 30.0244, 25.4444, 32.9823, 41.9045, 10.8661, -17.4348, -55.0841, 
22.9785, 26.8144, 29.3121, 12.3554, 32.6562, 33.9097, 10.8833, -8.62493, 
 },

 new double[] { // king eg
-94, -44, -37, -1, -13, -6, -10, -86, 
-10, 16, 25, 13, 28, 39, 38, 11, 
4, 21, 39, 46, 48, 43, 44, 19, 
-6, 27, 43, 56, 56, 52, 44, 22, 
-18, 14, 38, 54, 54, 43, 30, 14, 
-24, 0, 22, 34, 35, 27, 8, -5, 
-43, -15, -1, 11, 14, 4, -15, -34, 
-74, -58, -38, -18, -45, -20, -48, -77, 
 },
};



    public static double[] rawTunedPieceValues =
        
{ 81.7319, 314.038, 337.745, 455.726, 925.986, 0.0, 
121.293, 357.856, 368.092, 655.617, 1246.07, 0.0 };
//
// { 77.4184, 301.884, 324.512, 435.604, 879.878, 0.0, 
// 109.021, 330.511, 338.584, 593.574, 1129.52, 0.0 };



    public static int[][] tunedPsqts =>
        rawTunedPsqts.Select(psqt => psqt.Select(x => (int)Math.Round(x)).ToArray()).ToArray();
    
    public static int[] tunedPieceValues =>
        rawTunedPieceValues.Select(x => (int)Math.Round(x)).ToArray();
    
    
    // // Eg Values are tuned under the assumption that they are used t
    // public static int[] adjustKingEgTable(int[] tunedKingMgTable, int[] modifiedKingMgTable)
    
    public static (Decimal[], int, int) createCompressedPsqts()
    {
        // A decimal can store 12 easily accessible bytes, so the 12 * 64 + 6 + 2 * 6 bytes can be stored in 66 decimals
        Decimal[] compresto = new Decimal[66];
        // create a local copy that can be modified and prevents inadvertently trying to modify the global array
        int[][] tunedPsqts = Pesto.tunedPsqts;
        int[] tunedPieceValues = Pesto.tunedPieceValues;
        
        // first, compress the piece square tables
        int numOverflows = 0;
        byte[] decimalBytes = new byte[16];

        Decimal bytesToDecimal()
        {
            int[] bytesAsInts = new int[4];
            Buffer.BlockCopy(decimalBytes, 0, bytesAsInts, 0, 16);
            return new decimal(bytesAsInts);
        }

        Debug.Assert(tunedPsqts.Length == 12);
        for (int table = 0; table < tunedPsqts.Length; ++table)
        {
            int offset = Math.Min(-tunedPsqts[table].Min(), 255 - tunedPsqts[table].Max());
            // queen piece values tend to be too large to easily find a scaling constant,
            // but this greedy strategy solves that problem in practice
            if (table % 6 == 4) 
            {
                offset = Math.Max(-tunedPsqts[table].Min(), 255 - tunedPsqts[table].Max());
            }
            // Debug.Assert(offset >= 0);
            // Debug.Assert(offset <= 255);
            tunedPieceValues[table] -= offset;
            Debug.Assert(table % 6 == 5 || tunedPieceValues[table] >= 0);
            Debug.Assert(table % 6 == 5 || tunedPieceValues[table] < 2_000);
            tunedPsqts[table] = tunedPsqts[table].Select(val => val + offset).ToArray();
        }
        
        for (int row = 0; row < 8; ++row)
        {
            for (int column = 0; column < 8; ++column)
            {
                int square = row * 8 + column;
                for (int table = 0; table < tunedPsqts.Length; ++table)
                {
                    int psqtEntry = tunedPsqts[table][square];
                    Debug.Assert(psqtEntry <= 0xff);
                    if (psqtEntry < 0)
                    {
                        Console.WriteLine("Overflow on square {0}, piece {1}", square, table);
                        ++numOverflows;
                        psqtEntry = 0; // clamp to zero
                    }
                    decimalBytes[table] = (byte)(psqtEntry & 0xff);
                }
                compresto[square] = bytesToDecimal();
            }
        }
        Debug.Assert(compresto[64] == 0);
        Debug.Assert(numOverflows == 1); // only the piece square value for knight on a8 in the middle game overflows
        
        // compress the phase values
        Debug.Assert(piecePhase.Length == 6);
        Debug.Assert(tunedPieceValues.Length == 12);
        for (int i = 0; i < piecePhase.Length; ++i)
        {
            Debug.Assert(piecePhase[i] is >= 0 and <= 0xff);
            decimalBytes[i] = (byte)(piecePhase[i] & 0xff);
        }
        compresto[64] = bytesToDecimal();
        
        // compress the piece values

        int findScalingConstant(int[] values)
        {
            for (int factor = 0; factor < 100; ++factor)
            {
                int i = 0;
                for (; i < 5; ++i)
                {
                    if (values[i] - (factor << i) is < 0 or >= 256)
                        break;
                }
                if (i == 5) return factor;
            }
            // probably not the right exception type, but who cares?
            Console.WriteLine("values are " + string.Join(", ", values));
            throw new DataException("no scaling constant found");
        }

        int mgScaling = findScalingConstant(tunedPieceValues[..6]);
        int egScaling = findScalingConstant(tunedPieceValues[6..]);
        
        for (int i = 0; i < tunedPieceValues.Length; ++i) // the king's value doesn't matter
        {
            int compressedPieceVal = tunedPieceValues[i] - ((i < 6 ? mgScaling : egScaling) << (i % 6));
            Debug.Assert(compressedPieceVal is >= 0 and <= 0xff || i % 6 == 5);
            compressedPieceVal &= 0xff;
            // Console.WriteLine("compressed piece val {0}, reconstructed {1}", compressedPieceVal, compressedPieceVal + ((i < 6 ? mgScaling : egScaling) << (i % 6)));
            decimalBytes[i] = (byte)compressedPieceVal;
        }
        compresto[65] = bytesToDecimal();
        testCompressedEval(compresto, mgScaling, egScaling);
        return (compresto, mgScaling, egScaling);
    }

    // This array contains not only the piece square tables, but also the phase weights and the piece values
    // public static decimal[] compresto = createCompressedEval();
    
    // uncompress it like this, but replace the `compresto` variable with the hard-coded values
    // (which you can get using the printCompressedPesto() function):
    // public static byte[] evalData = compresto.SelectMany(BitConverter.GetBytes).ToArray();
    
    public static void printCompressedPsqt()
    {
        var (compressed, mgScaling, egScaling) = createCompressedPsqts();
        Console.WriteLine("{ " + string.Join(", ", compressed) + " }");
        Console.WriteLine("Scaling: {0}, {1}", mgScaling, egScaling);
    }
    
    public static void testCompressedEval(Decimal[] compresto, int mgScaling, int egScaling)
    {
        byte[] uncompressedPsqts = compresto.SelectMany(decimal.GetBits).SelectMany(BitConverter.GetBytes).ToArray();
        Debug.Assert(uncompressedPsqts.Length == 66 * 16);
        for (int i = 0; i < piecePhase.Length; ++i)
        {
            Debug.Assert(piecePhase[i] == uncompressedPsqts[64 * 16 + i]);
        }

        int[] uncompressedPieceValues = new int[tunedPieceValues.Length];
        Debug.Assert(tunedPieceValues.Length == 12);
        // Console.WriteLine("Scaling factors: {0}, {1}", mgScaling, egScaling);

        for (int i = 0; i < tunedPieceValues.Length; ++i)
        {
            uncompressedPieceValues[i] = uncompressedPsqts[65 * 16 + i] + ((i < 6 ? mgScaling : egScaling) << (i % 6));
            // Console.WriteLine("piece {0}, value {1}", i, uncompressedPieceValues[i]);
            // pesto piece values are changed by subtracting a table-specific offset, so only use >= for comparison
            Debug.Assert(i % 6 == 5 || // the king's piece value doesn't matter
                         tunedPieceValues[i] + 50 >= uncompressedPieceValues[i]);
        }
        
        for (int square = 0; square < 64; ++square)
        {
            for (int piece = 0; piece < 12; ++piece)
            {
                int i = 16 * square + piece;
                if (piece == 1 && square == 0) // the middle game knight on a8 value can't be represented properly in compressed pesto 
                {
                    Debug.Assert(uncompressedPsqts[i] == 0);
                    Debug.Assert(uncompressedPsqts[i] + uncompressedPieceValues[piece] >= tunedPsqts[piece][square] + tunedPieceValues[piece]);
                    Debug.Assert(uncompressedPsqts[i] + uncompressedPieceValues[piece] - 50 <= tunedPsqts[piece][square] + tunedPieceValues[piece]);
                }
                else if (piece % 6 != 5)
                { // king values differ, but that's fine because the white and black values cancel each other out
                    // Console.WriteLine("psqt {0}, piece val {1}, should be {2}, {3}; square {4}, piece {5}", uncompressedPsqts[i], uncompressedPieceValues[piece],
                    //     tunedPsqts[piece][square] , tunedPieceValues[piece], square, piece);
                    Debug.Assert(uncompressedPsqts[i] + uncompressedPieceValues[piece] == tunedPsqts[piece][square] + tunedPieceValues[piece]);
                }
            }
        }
    }

    // This function is useful for testing that the pesto compression worked. Not meant to be called in the actual bot.
    // The code is adapted from cpw (https://www.chessprogramming.org/PeSTO%27s_Evaluation_Function)
    public static int uncompressedEval(Board board)
    {            
        int[] mg = new int[2];
        int[] eg = new int[2];
        int gamePhase = 0;
    
        const int WHITE = 0;
        const int BLACK = 1;
        
        mg[WHITE] = 0;
        mg[BLACK] = 0;
        eg[WHITE] = 0;
        eg[BLACK] = 0;
    
        /* evaluate each piece */
        for (int sq = 0; sq < 64; ++sq)
        {
            // chess challenge square numbers start at a1, but pesto square numbers start at a8
            Piece piece = board.GetPiece(new Square(sq ^ 56));
            int square = piece.IsWhite ? sq : sq ^ 56;
            int pc = (int)piece.PieceType - 1;
            if (piece.PieceType != PieceType.None) {
                mg[piece.IsWhite ? WHITE : BLACK] += tunedPsqts[pc][square] + tunedPieceValues[pc];
                eg[piece.IsWhite ? WHITE : BLACK] += tunedPsqts[pc + 6][square] + tunedPieceValues[pc + 6];
                gamePhase += piecePhase[pc];
            }
            // Console.Write("(" + (pc >= 0 ? pestoPsqts[pc][square] : -1) + ") " + pc + ";  ");
            // if (sq % 8 == 7) Console.WriteLine();
        }

        var onA8 = board.GetPiece(new Square("a8"));
        if (onA8.PieceType == PieceType.Knight && onA8.IsWhite)
        {
            mg[WHITE] += 41;
        }

        var onA1 = board.GetPiece(new Square("a1"));
        if (onA1.PieceType == PieceType.Knight && !onA1.IsWhite)
        {
            mg[BLACK] += 41;
        }
        
        /* tapered eval */
        int mgScore = mg[WHITE] - mg[BLACK];
        int egScore = eg[WHITE] - eg[BLACK];
        int mgPhase = gamePhase;
        // this isn't done for the challenge pesto eval
        // if (mgPhase > 24) mgPhase = 24; /* in case of early promotion */
        int egPhase = 24 - mgPhase;
        return (mgScore * mgPhase + egScore * egPhase) / 24 * (board.IsWhiteToMove ? 1 : -1);
    }
    
}
